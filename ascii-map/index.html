<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sorn-Lai ASCII Map</title>
<style>
:root { color-scheme: dark; --fg:#e7e7e7; --bg:#0d0d0f; --muted:#9aa0a6; --accent:#a88cff; --grid:#222; }
*{box-sizing:border-box} body{margin:0;font:16px/1.5 ui-monospace,Consolas,monospace;background:var(--bg);color:var(--fg)}
a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
.wrapper{max-width:980px;margin:auto;padding:16px}
.btn{display:inline-block;padding:8px 12px;border:1px solid #2a2a30;border-radius:8px}
.axis{display:flex;justify-content:space-between}
pre.map{white-space:pre; font:14px/1.05 ui-monospace,Consolas,monospace; background:#0a0a0c; padding:10px; border-radius:12px; border:1px solid var(--grid); overflow:auto; max-height:70vh}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.legend .key{display:flex;align-items:center;gap:6px}
.legend .sw{width:14px;height:14px;border-radius:3px;display:inline-block;outline:1px solid #444}
a.sel{ color:#ff5f5f !important; font-weight:700 } /* selected glyph = RED */
.dim{ color:#8aa; }
.controls{display:flex;gap:8px;align-items:center;margin:6px 0}
</style>
</head><body>
<div class="wrapper">
  <a class="btn" href="../index.html">← Micros Hub</a>
  <h1>ASCII Map <small id="subtitle"></small></h1>

  <div class="legend">
    <span class="key"><span class="sw" style="background:#a88cff"></span><small>Creatures (linked)</small></span>
    <span class="key"><span class="sw" style="background:#ff5f5f"></span><small>Selected</small></span>
    <span class="key"><span class="sw" style="background:#20304a"></span><small>Background</small></span>
  </div>

  <div class="axis"><span id="lonMin" class="dim"></span><span id="lonMax" class="dim"></span></div>
  <pre class="map" id="map" role="img" aria-label="ASCII map of Sorn-Lai"></pre>
  <div class="axis"><span id="latMin" class="dim"></span><span id="latMax" class="dim"></span></div>

  <div class="controls">
    <button id="toggle" class="btn" type="button">⏸️ Pause</button>
    <small id="fps" class="dim"></small>
  </div>
</div>

<script>
(async function(){
  async function loadJSON(path){ const r=await fetch(path,{cache:"no-store"}); if(!r.ok) throw new Error("Load "+path+" "+r.status); return r.json(); }
  const $=(s,r=document)=>r.querySelector(s);
  const linkToGuide=(id)=>`../field-guide/index.html?id=${encodeURIComponent(id)}`;
  const getQuery=(k)=>new URLSearchParams(location.search).get(k);

  const data = await loadJSON("../data/entries.json");
  const selectedId = getQuery("id");
  localStorage.setItem("sornlai_selected", selectedId || ""); // expose selection for the guide

  const W=72,H=24, TICK_MS=200, SPEED=0.00035, PAD=0.02;
  const lats=data.map(e=>+e.coords?.[0]).filter(Number.isFinite);
  const lons=data.map(e=>+e.coords?.[1]).filter(Number.isFinite);
  const latMin=Math.min(...lats)-0.05, latMax=Math.max(...lats)+0.05;
  const lonMin=Math.min(...lons)-0.05, lonMax=Math.max(...lons)+0.05;

  $("#lonMin").textContent=`${lonMin.toFixed(2)}°`; $("#lonMax").textContent=`${lonMax.toFixed(2)}°`;
  $("#latMin").textContent=`${latMin.toFixed(2)}°`; $("#latMax").textContent=`${latMax.toFixed(2)}°`;
  $("#subtitle").textContent=`lat ${latMin.toFixed(2)}→${latMax.toFixed(2)} | lon ${lonMin.toFixed(2)}→${lonMax.toFixed(2)}`;

  const glyph=(g)=>({"Pearl-Weaver":"◊","Memory-Gardener":"*","Way-Finder":"o"}[g]||"+");
  const toXY=(lat,lon)=>({ x:Math.round(((lon-lonMin)/(lonMax-lonMin))*(W-1)),
                           y:Math.round((1-((lat-latMin)/(latMax-latMin)))*(H-1)) });

  // state
  const rng=(s)=>()=> (s=(s*1664525+1013904223)>>>0, s/4294967296);
  const rand=rng((Date.now()^0x9e3779b9)>>>0);
  const movers=data.filter(e=>e.coords && Number.isFinite(+e.coords[0]) && Number.isFinite(+e.coords[1]))
    .map(e=>{
      const a=rand()*Math.PI*2, sp=SPEED*(0.5+rand());
      return {id:e.id,title:e.title||e.id,guild:e.guild||"",g:glyph(e.guild),
              lat:+e.coords[0],lon:+e.coords[1], vx:Math.cos(a)*sp, vy:Math.sin(a)*sp};
    });

  const pre=$("#map"), toggle=$("#toggle"), fpsEl=$("#fps");
  let running=true, lastTick=performance.now(), frames=0, lastFps=performance.now();

  function step(dt){
    movers.forEach(m=>{
      const jitter=(rand()-0.5)*SPEED*0.2;
      m.vx+=jitter; m.vy+=jitter;
      m.lat+=m.vy*(dt/TICK_MS); m.lon+=m.vx*(dt/TICK_MS);
      if(m.lat<latMin+PAD){ m.lat=latMin+PAD; m.vy=Math.abs(m.vy); }
      if(m.lat>latMax-PAD){ m.lat=latMax-PAD; m.vy=-Math.abs(m.vy); }
      if(m.lon<lonMin+PAD){ m.lon=lonMin+PAD; m.vx=Math.abs(m.vx); }
      if(m.lon>lonMax-PAD){ m.lon=lonMax-PAD; m.vx=-Math.abs(m.vx); }
    });
    // broadcast positions for the Field Guide (other tab) to consume
    localStorage.setItem("sornlai_positions",
      JSON.stringify({ts:Date.now(), positions:movers.map(m=>({id:m.id, lat:m.lat, lon:m.lon}))})
    );
  }

  function render(){
    const grid=Array.from({length:H},()=>Array.from({length:W},()=>'.'));
    for(let y=0;y<H;y+=6) for(let x=0;x<W;x++) grid[y][x]='-';
    for(let x=0;x<W;x+=12) for(let y=0;y<H;y++) grid[y][x]='|';

    const anchors=[];
    movers.forEach(m=>{
      const {x,y}=toXY(m.lat,m.lon);
      grid[y][x]=m.g;
      anchors.push({x,y,id:m.id,title:m.title,label:m.guild,selected:(m.id===selectedId)});
    });

    let out="";
    for(let y=0;y<H;y++){ for(let x=0;x<W;x++){ const a=anchors.find(a=>a.x===x&&a.y===y); out+= a?`\uFFFF${x},${y}\uFFFF` : grid[y][x]; } out+="\n"; }
    pre.textContent=out;
    pre.innerHTML=pre.textContent.replace(/\uFFFF(\d+),(\d+)\uFFFF/g,(m,xx,yy)=>{
      const a=anchors.find(a=>a.x==xx&&a.y==yy);
      const cls=a.selected?"sel":"";
      return `<a class="${cls}" href="${linkToGuide(a.id)}" title="${a.title} (${a.label})">${grid[yy][xx]}</a>`;
    });
  }

  function loop(now){
    if(!running){ requestAnimationFrame(loop); return; }
    const dt=now-lastTick;
    if(dt>=TICK_MS){ lastTick=now; step(dt); render(); frames++; }
    if(now-lastFps>=1000){ fpsEl.textContent=`${frames} updates/sec`; frames=0; lastFps=now; }
    requestAnimationFrame(loop);
  }
  render(); requestAnimationFrame(loop);
  toggle.addEventListener("click",()=>{ running=!running; toggle.textContent=running?"⏸️ Pause":"▶️ Play"; });
})();
</script>
</body></html>
