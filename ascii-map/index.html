<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sorn-Lai ASCII Map</title>
<style>
:root { color-scheme: dark; --fg:#e7e7e7; --bg:#0d0d0f; --muted:#9aa0a6; --accent:#8af; }
*{box-sizing:border-box} body{margin:0;font:16px/1.5 ui-monospace,Consolas,monospace;background:var(--bg);color:var(--fg)}
a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
.wrapper{max-width:980px;margin:auto;padding:16px}
.btn{display:inline-block;padding:8px 12px;border:1px solid #2a2a30;border-radius:8px}
.axis{display:flex;justify-content:space-between}
pre.map{white-space:pre; font:14px/1.05 ui-monospace,Consolas,monospace; background:#0a0a0c; padding:10px; border-radius:12px; border:1px solid #222; overflow:auto; max-height:70vh}
#debug{white-space:pre-wrap;background:#120f15;border:1px solid #362447;border-radius:8px;padding:8px;margin-top:10px;color:#e6d9ff;display:none}
</style>
</head><body>
<div class="wrapper">
  <a class="btn" href="../index.html">← Micros Hub</a>
  <h1>ASCII Map <small id="subtitle"></small></h1>
  <div class="axis"><span id="lonMin"></span><span id="lonMax"></span></div>
  <pre class="map" id="map" role="img" aria-label="ASCII map of Sorn-Lai"></pre>
  <div class="axis"><span id="latMin"></span><span id="latMax"></span></div>
  <p><small>Tip: click a glyph to open its Field Guide entry.</small></p>
  <pre id="debug" aria-live="polite"></pre>
</div>

<script>
(function(){
  async function loadJSON(path){
    const r = await fetch(path, {cache:"no-store"});
    if(!r.ok) throw new Error("Failed to load "+path+" ("+r.status+")");
    return r.json();
  }
  const $=(s,r=document)=>r.querySelector(s);
  function getQueryParam(name){ return new URLSearchParams(location.search).get(name); }
  function linkToGuide(id){ return `../field-guide/index.html?id=${encodeURIComponent(id)}`; }
  const dbg = $("#debug");
  function logDebug(msg){ dbg.style.display="block"; dbg.textContent += msg+"\n"; console.log(msg); }

  (async function main(){
    try{
      logDebug("ASCII Map booting…");
      const dataUrl = "../data/entries.json";
      logDebug("Fetching: "+dataUrl);
      const data = await loadJSON(dataUrl);
      logDebug("Loaded entries: "+data.length);

      const selectedId = getQueryParam("id");
      const W = 72, H = 24;

      if(!Array.isArray(data) || data.length===0){
        logDebug("No data rows found. Check entries.json.");
        return;
      }

      // bounds
      const lats=data.map(e=>+e.coords?.[0]).filter(Number.isFinite);
      const lons=data.map(e=>+e.coords?.[1]).filter(Number.isFinite);
      const latMin=Math.min(...lats)-0.05, latMax=Math.max(...lats)+0.05;
      const lonMin=Math.min(...lons)-0.05, lonMax=Math.max(...lons)+0.05;

      $("#lonMin").textContent = `${lonMin.toFixed(2)}°`;
      $("#lonMax").textContent = `${lonMax.toFixed(2)}°`;
      $("#latMin").textContent = `${latMin.toFixed(2)}°`;
      $("#latMax").textContent = `${latMax.toFixed(2)}°`;
      $("#subtitle").textContent = `lat ${latMin.toFixed(2)}→${latMax.toFixed(2)} | lon ${lonMin.toFixed(2)}→${lonMax.toFixed(2)}`;

      // base grid
      const grid = Array.from({length:H}, _=>Array.from({length:W}, _=>'.'));
      for(let y=0;y<H;y+=6) for(let x=0;x<W;x++) grid[y][x]='-';
      for(let x=0;x<W;x+=12) for(let y=0;y<H;y++) grid[y][x]='|';

      const glyph=(g)=>({"Pearl-Weaver":"◊","Memory-Gardener":"*","Way-Finder":"o"}[g]||"+");
      function toXY([lat,lon]){
        const x = Math.round(((lon - lonMin)/(lonMax - lonMin))*(W-1));
        const y = Math.round((1-((lat - latMin)/(latMax - latMin)))*(H-1));
        return {x,y};
      }

      const anchors=[];
      data.forEach(e=>{
        if(!e.coords || !Number.isFinite(+e.coords[0]) || !Number.isFinite(+e.coords[1])) return;
        const {x,y}=toXY([+e.coords[0],+e.coords[1]]);
        grid[y][x] = (e.id===selectedId) ? glyph(e.guild).toUpperCase() : glyph(e.guild);
        anchors.push({x,y,id:e.id,title:e.title||e.id,label:e.guild||""});
      });

      const pre=$("#map");
      let out="";
      for(let y=0;y<H;y++){
        for(let x=0;x<W;x++){
          const mark=anchors.find(a=>a.x===x&&a.y===y);
          out += mark ? `\uFFFF${x},${y}\uFFFF` : grid[y][x];
        }
        out+="\n";
      }
      pre.textContent=out;
      const html = pre.textContent.replace(/\uFFFF(\d+),(\d+)\uFFFF/g,(m,xx,yy)=>{
        const a = anchors.find(a=>a.x==xx && a.y==yy);
        return `<a href="${linkToGuide(a.id)}" title="${a.title} (${a.label})">${grid[yy][xx]}</a>`;
      });
      pre.innerHTML=html;
      logDebug("Map render complete with "+anchors.length+" anchors.");
    }catch(err){
      logDebug("ERROR: "+(err && err.message ? err.message : err));
      logDebug("Tip: open the JSON directly: ../data/entries.json");
    }
  })();
})();
</script>
</body></html>
